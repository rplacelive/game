<!DOCTYPE html>
<html lang="en" ontouchstart="if (maincontent.contains(event.target)) event.preventDefault()" ontouchend="event.preventDefault()">
<head>
	<script>
		const SERVER_OFFLINE_B64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAYAAACOEfKtAAAAAXNSR0IArs4c6QAAAddJREFUeF7tnFEOgyAUBOGQegQP5RG8pA0fNIRohUxTQ53+tbKmTPftEzGN0zTt4cGvbdvQ7KMABYgcpAMRvhAEKEBIAMp1oAAhASjXgQKEBKBcBwoQEoByHShASADKdaAAIQEov92B9AvA+WP5PM/oHPh+oADhHWkBCtASJgTMQEIvhCBAAUICUK4DBQgJQLkOFCAkAOU6UICQAJTrQAFCAlA+vAPXdUUIlmVBegEKUAeiErKE4TPGAhQge0qf7onoQB2oA0kXvH1f2BK2hC1hSxgQcC3sWti1MCigEOzCsAsj+l8QD5+BX2CATjEcwBjje8L7voez9+lYeqXjeVzL+F6aQwLMcEpAeeJHwGqAR/qsewTAPMnSUaXj0vErB56N/3uAZ0779HnprtpptWP/HmBLBpYlW5f5kb4e3wNxuAzsmdwvxg4DsMV5dTbWzaIlO8v8bPkBhgLY0k3rLCwhHGXhYzLw7Hruqvv2AOx1XxqvA6sL7ZayLccMBfAq41oyL7vsaoXSCnIYgK0T+vU4AULiAnw6QOoAyA/Lb98XFiC8Iy1AAd67sa4DdaAOJK3YLkzopU0v+jfI9AlVM9AMNANJFVvChJ4ZCOkJUICcADyDGQgBvgBxwKKvpzakwAAAAABJRU5ErkJggg"
		const CHAT_COLOURS = ["lightblue", "navy", "green", "purple", "grey", "brown", "orangered", "gold"]
		const VERIFIED_APP_HASH = "90e58b1f2c5fb98f74962806b85c2d7d3f7b18be8abe7a04f21e939868625357"
		const UNMUTED_SVG = '<path d="M10.543.5a1.12 1.12 0 00-1.182.117L3.789 4.875h-1.8A1.127 1.127 0 00.868 6v8a1.127 1.127 0 001.125 1.125h1.8l5.572 4.258a1.117 1.117 0 00.681.232 1.128 1.128 0 001.127-1.126V1.511A1.119 1.119 0 0010.543.5zm-.624 17.736l-5.708-4.361H2.118v-7.75h2.093l5.708-4.361zM13 3.375v1.25a5.375 5.375 0 010 10.75v1.25a6.625 6.625 0 000-13.25z"></path><path d="M16.125 10A3.129 3.129 0 0013 6.875v1.25a1.875 1.875 0 010 3.75v1.25A3.129 3.129 0 0016.125 10z"></path>'
		const MUTED_SVG = '<path d="M19.442 7.442l-.884-.884L16.5 8.616l-2.058-2.058-.884.884L15.616 9.5l-2.058 2.058.884.884 2.058-2.058 2.058 2.058.884-.884L17.384 9.5l2.058-2.058zM10.543.5a1.12 1.12 0 00-1.182.117L3.789 4.875h-1.8A1.127 1.127 0 00.868 6v8a1.127 1.127 0 001.125 1.125h1.8l5.572 4.258a1.117 1.117 0 00.681.232 1.128 1.128 0 001.127-1.126V1.511A1.119 1.119 0 0010.543.5zm-.624 17.736l-5.708-4.361H2.118v-7.75h2.093l5.708-4.361z"></path>'
		const VOTED_SVG = 'M8.44857 0.401443C8.3347 0.273284 8.17146 0.199951 8.00002 0.199951C7.82859 0.199951 7.66534 0.273284 7.55148 0.401443L0.351479 8.50544C0.194568 8.68206 0.155902 8.93431 0.252709 9.14981C0.349516 9.36532 0.563774 9.50395 0.800023 9.50395H4.20002V15C4.20002 15.3313 4.46865 15.6 4.80002 15.6H11.2C11.5314 15.6 11.8 15.3313 11.8 15V9.50395H15.2C15.4363 9.50395 15.6505 9.36532 15.7473 9.14981C15.8441 8.93431 15.8055 8.68206 15.6486 8.50544L8.44857 0.401443Z'
		const UNVOTED_SVG = 'm8 .200001c.17143 0 .33468.073332.44854.201491l7.19996 8.103998c.157.17662.1956.42887.0988.64437-.0968.21551-.3111.35414-.5473.35414h-3.4v5.496c0 .3314-.2686.6-.6.6h-6.4c-.33137 0-.6-.2686-.6-.6v-5.496h-3.4c-.236249 0-.450507-.13863-.547314-.35414-.096807-.2155-.058141-.46775.09877-.64437l7.200004-8.103998c.11386-.128159.27711-.201491.44854-.201491zm-5.86433 8.103999h2.66433c.33137 0 .6.26863.6.6v5.496h5.2v-5.496c0-.33137.2686-.6.6-.6h2.6643l-5.8643-6.60063'

		const TRANSLATIONS = {
			en: {
				connecting: "Connecting...",
				connectingFail: "Could not connect!",
				downloadingImage: "Downloading image...",
				placeTile: "Place a tile",
				donate: "Donate",
				chat:"Chat",
				liveChat: "Live Chat:",
				enterNickname: "Enter a nickname to continue:",
				changeChannel: "Change channel:",
				captchaPrompt: "Please solve this small captcha to help keep rplace.tk fun for all..."
			},
			fa: {
				connecting: "در حال وصل شدن",
				connectingFail: "متصل نشد",
				downloadingImage: "در حال بارگزاری عکس ها",
				placeTile: "نقاشی کردن",
				donate: "حمایت",
				chat: "چت",
				liveChat: "چت زنده",
				enterNickname: "لطفا نام خود را برای چت کردن وارد کنید",
				changeChannel: "تغییر کانال:",
				captchaPrompt: "لطفا روی دکمه حاوی ایموجی که در زیر می بینید کلیک کنید"
			},
			tr: {
				connecting: "Bağlanıyor...",
				connectingFail: "Bağlanamadı!",
				downloadingImage: "Resim indiriliyor...",
				placeTile: "Bir karo yerleştir",
				donate: "Bağış yap",
				chat: "Sohbet",
				liveChat: "Canlı sohbet:",
				enterNickname: "Devam etmek için bir takma ad girin:",
				changeChannel: "Kanalı değiştir:",
				captchaPrompt: "Lütfen aşağıda gördüğünüz emojiyi içeren butona tıklayın"
			},
			ro: {
				connecting: "Se conectează...",
				connectingFail: "Nu s-a putut conecta!",
				downloadingImage: "Se descarcă imaginea...",
				placeTile: "Pune un pixel",
				donate: "Donează",
				chat: "Conversații",
				liveChat: "Conversații în direct:",
				enterNickname: "Introdu un nume pentru a continua:",
				changeChannel: "Schimbați canalul:",
				captchaPrompt: "Dați clic pe butonul care conține emoji-ul pe care îl vedeți mai jos"
			},
			el: {
				connecting: "Συνδετικός...",
				connectingFail: "Δεν μπορούσε να συνδεθεί!",
				downloadingImage: "Λήψη εικόνας...",
				placeTile: "τοποθετώ ένα πίξελ",
				donate: "δανεισω",
				chat: "συζήτηση",
				liveChat: "ζωντανή συζήτηση",
				enterNickname: "Εισαγάγετε ένα ψευδώνυμο για να συνεχίσετε:",
				changeChannel: "Αλλαγή καναλιού:",
				captchaPrompt: "Κάντε κλικ στο κουμπί που περιέχει το emoji που βλέπετε παρακάτω"
			},
			es: {
				connecting: "Conectando...",
				connectingFail: "¡No podía conectar!",
				downloadingImage: "Descargando imagen...",
				placeTile: "Coloca un pixel",
				donate: "Donar",
				chat: "Chat",
				liveChat: "Chat en vivo:",
				enterNickname: "Introduce un apodo para continuar:",
				changeChannel: "Cambia el canal:",
				captchaPrompt: "Haga clic en el botón que contiene el emoji que ve a continuación"
			},
			fr: {
				connecting: "De liaison...",
				connectingFail: "Impossible de se connecter!",
				downloadingImage: "Télécharger l'image...",
				placeTile: "Place un pixel",
				donate: "Faire un don",
				chat: "Discuter",
				liveChat: "Chat en direct:",
				enterNickname: "Entrez un surnom pour continuer :",
				changeChannel: "Changer de chaîne:",
				captchaPrompt: "Veuillez cliquer sur le bouton contenant l'emoji que vous voyez ci-dessous"
			}
		}

		const AUDIOS = {
			invalid: new Audio('https://hot-potato.reddit.com/media/interactions/invalid.mp3'),
			highlight: new Audio('https://hot-potato.reddit.com/media/interactions/highlight.mp3'),
			selectColor: new Audio('https://hot-potato.reddit.com/media/interactions/select-color.mp3'),
			closePalette: new Audio('https://hot-potato.reddit.com/media/interactions/close-pallette.mp3'),
			cooldownStart: new Audio('https://hot-potato.reddit.com/media/interactions/cooldown-start.mp3'),
			cooldownEnd: new Audio('https://hot-potato.reddit.com/media/interactions/cooldown-end.mp3')
		}

		const EMOJIS = {
			joy: "😂",
			cool: "😎",
			sunglasses: "😎",
			heart: "❤️",
			moyai: "🗿",
			bruh: "🗿",
			turkey: "🇹🇷",
			skull: "💀",
			amongus: "ඞ",
			sus: "ඞ",
			iran: "🇮🇷",
			uk: "🇬🇧",
			usa: "🇺🇸",
			america: "🇺🇸"
		}
	</script>
	<script>
		let queryChanged = false

		for (let [query, val] of new URLSearchParams(location.search)) {
			if (query == "server" || query == "board") {
				if (localStorage.getItem(query) == val) continue
				
				localStorage.setItem(query, val)
				queryChanged = true
			}
		}

		if (queryChanged)
			window.location.reload()	
		
		// Register PWA Service worker
		if ('serviceWorker' in navigator)
			navigator.serviceWorker.register("./sw.js")

		let v = 0
		const wscapsule = ((send, addEventListener, call) => {
			let focused = true
			call(addEventListener, window, 'blur', () => focused = false)
			call(addEventListener, window, 'focus', () => focused = true)
			let j = 0
			const cch = call(Array.prototype.slice, contents.children, 1)

			for (let i of cch) {
				let id = j++
				i = i.children[0].children[0]
				let applyVote = (e) => {
					const vote = i.children[0].getAttribute('d') == UNVOTED_SVG
					i.children[0].setAttribute('d', vote ? VOTED_SVG : UNVOTED_SVG)
					i.style.fill = vote ? "#ff4500" : ""
					const u = vote ? ++i.nextElementSibling.u : --i.nextElementSibling.u
					i.nextElementSibling.innerText = u < 100e3 ? (u < 1000 ? u : Math.floor(u / 100) / 10 + 'k') : (u < 1e6 ? Math.floor(u / 1000) + 'k' : Math.floor(u / 100e3) / 10 + 'M')
					if (localStorage.vote & (1 << id) && !(v & (1 << id))) return
					localStorage.vote |= (1 << id)
					v |= (1 << id)

					call(send, ws, new Uint8Array([20, id]))
				}

				call(addEventListener, i, 'click', applyVote)
			}

			let ws = new WebSocket((localStorage.server || 'wss://server.rplace.tk:443') + (localStorage.vip ? "/" + localStorage.vip : ""))
			delete WebSocket

			ws.onmessage = async function({data}){
				delete sessionStorage.err
				data = new DataView(await data.arrayBuffer())
				let code = data.getUint8(0)
				if (code == 0) {
					//This should give us an array of integers, for each canvas palette colour
					PALETTE = new Uint32Array(data.buffer.slice(1))
					generateIndicators()
					generatePalette()
				}
				if (code == 1) {
					CD = data.getUint32(1) * 1000
					COOLDOWN = data.getUint32(5)

					// New server packs canvas width and height in code 1, making it 17
					if (data.byteLength == 17) {
						let width = data.getUint32(9)
						let height = data.getUint32(13)

						setsize(width, height)

						// If fetch board occurred before this packet, board data is already saved in 'load',
						// and we render board, otherwise, we tell fetch that when it completes, we should go
						// in non-legacy mode and render the board then.
						if (load) {
							board = new Uint8Array(load)
							renderAll()
							loadingScreen.style.opacity = 0
							setTimeout(() => loadingScreen.remove(), 300)
							setTimeout(() => waitingGame.stop(), 300)
							return
						}

						legacy = false
					}
				}
				else if (code == 2) {
					//run length coding
					if (!load) load = data
					else runLengthChanges(data, load)
				}
				else if (code == 3) {
					online = data.getUint16(1)
					onlineCounter.textContent = online
					onlineCounter2.textContent = online + ' online'
					let i = 0
					while (i < (data.byteLength >> 2)){
						let u = data.getUint32((i << 2) + 3)
						if (!cch[i])break
						cch[i].children[0].children[1].u = u
	                    cch[i].children[0].children[1].innerText = u < 100e3 ? (u < 1000 ? u : Math.floor(u/100)/10+'k') : (u < 1e6 ? Math.floor(u/1000)+'k' : Math.floor(u/100e3)/10 + 'M')
						i++
					}
				}
				else if (code == 6) {
					let i = 0
					while (i < data.byteLength - 2) { seti(data.getUint32(i += 1), data.getUint8(i += 4)) }
				}
				else if (code == 7) {
					CD = data.getUint32(1) * 1000
					seti(data.getUint32(5), data.getUint8(9))
				}
				else if (code == 15) {
					let txt = censor(decoder.decode(new Uint8Array(data.buffer).slice(1))).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;")
					let name, messageChannel, type, placeX, placeY
					[txt, name, messageChannel, type, placeX, placeY] = txt.split("\n")
					if (!(messageChannel in cMessages)) return
					if (name) name = name.replace(/\W+/g,'').toLowerCase()
					if (!txt) return
					txt = txt.replace(/:(.+):/, (_, source) => `<img src="custom_emojis/${source}.png" alt=":${source}:" width="16" height="16">`)
					
					if (type == 'place') {
						//Place chat, chat that is placed on the canvas at the position as a "bubble"
						txt = txt.substring(0, 56)

						const placeMessage = document.createElement("placechat")
						placeMessage.innerHTML = `<span title="${(new Date()).toLocaleString()}" style="color: ${CHAT_COLOURS[name ? hash(name) & 7 : (Math.round(Math.random() * 8))]};">[${name || "anon"}]</span> ${txt}`
						placeMessage.style.left = placeX + "px"
						placeMessage.style.top = placeY + "px"
						canvparent2.appendChild(placeMessage)

						//Remove message after given time. TODO: Make customisable
						setTimeout(() => {
							canvparent2.removeChild(placeMessage) 
						}, localStorage.placeChatTime || 7e3)
					}
					else if (!type || type == 'live') {
						//Normal chat - goes to live chat panel
						let newMessage = document.createElement("div")
						newMessage.innerHTML = `<span title="${(new Date()).toLocaleString()}" style="color: ${CHAT_COLOURS[name ? hash(name) & 7 : (Math.round(Math.random() * 8))]}; cursor: pointer;" onclick="chatMentionUser(this.textContent.slice(1, -1));" oncontextmenu="onChatContext(event, '${name}')">[${name || "anon"}]</span> ${txt}\n`
						let scroll = chatMessages.scrollTop+chatMessages.offsetHeight+10>=chatMessages.scrollHeight

						if (name !== localStorage.name && blockedUsers.includes(name)) {
							newMessage.style.color = "transparent"
							newMessage.style.textShadow = "0px 0px 6px black"
						}
						if (localStorage.name && txt.includes("@" + localStorage.name.replace(/\W+/g,'').toLowerCase())) {
							newMessage.style.backgroundColor = "rgba(255, 255, 0, 0.5)"
							if (currentChannel == messageChannel) AUDIOS.closePalette.run()
						}
						messageChannel = messageChannel || 'en'
						cMessages[messageChannel].push(newMessage)
						if (cMessages[messageChannel].length > 100)cMessages[messageChannel].unshift()
						if (currentChannel == messageChannel) {
							chatMessages.insertAdjacentElement("beforeEnd", newMessage)
						}

						if (chatMessages.children.length > 100){
							chatMessages.children[0].remove()
						}
						scroll && chatMessages.scrollTo(0,10e8)
					}
				}
				else if (code == 16) {
					let type = data.getUint8(1)
					switch (type) {
						// Text capcha
						case 1:
							break
						// Math captcha
						case 2:
							break
						// Emoji captcha
						case 3:
							let emojis = (decoder.decode(new Uint8Array(data.buffer).slice(2, 12))).split("\n")
							let imageData = new Uint8Array(data.buffer).slice(13)
							
							for (let emoji of emojis) {
								let el = docment.createElement("input")
								el.setAttribute("type", "button")
								el.setAttribute("value", emoji)
								captchaOptions.appendChild(el)

								// 0x10 = 16 (hex)
								el.addEventListener("click", (event) => {
									call(send, ws, encoder.encode("\x10" + event.target.value))
									captchaOptions.style.pointerEvents = "none"
								})

								el.addEventListener("touchend", (event) => {
									call(send, ws, encoder.encode("\x10" + event.target.value))
									captchaOptions.style.pointerEvents = "none"
								})
							}
							
							capchaImg.src = URL.createObjectURL(new Blob([imageData], { type: "image/webp" }))
							captchaPopup.style.display = "block"
							break
						// Server sends back sucess
						case 255:
							captchaPopup.style.display = "none"
							break
					}
				}
			}
			ws.onclose = (e) => {
				if (CD != Infinity) {
					window.location.reload(true)
				}

				//Something went wrong...
				CD = 1e100
				console.error(e)
				if (e.code == 1006 && !sessionStorage.err) {
					sessionStorage.err = "1"
					window.location.reload(true)
				}
				else {
					loadingScreen.children[0].src = SERVER_OFFLINE_B64
					waitingGame.start()
				}
			}

			function put(){
				if (!focused || CD > Date.now()) {
					return
				}
				
				canvselect.style.background = ""
				palette.style.transform = "translateY(100%)"
				colors.children[PEN].classList.remove("sel")

				pok.classList.remove("enabled")
				set(Math.floor(x), Math.floor(y), PEN)
				canvselect.children[0].style.display='block'
				canvselect.style.outline = ""
				canvselect.style.boxShadow = ""
				AUDIOS.cooldownStart.run()
				CD = Date.now() + (localStorage.vip ? (localStorage.vip[0] == '!' ? 0 : COOLDOWN/2) : COOLDOWN)

				let pixelView = new DataView(new Uint8Array(6).buffer)
				pixelView.setUint8(0, 4)
				pixelView.setUint32(1, Math.floor(x) + Math.floor(y) * WIDTH)
				pixelView.setUint8(5, PEN)
				PEN = -1
				localStorage.placed = (localStorage.placed >>> 0) + 1
				call(send, ws, pixelView)
			}

			let pok = document.getElementById('pok')
			
			let oclick = e => {
				if (!e.isTrusted) return
				if (pok.classList.contains('enabled')) put()
				hideIndicators()
			}
			call(addEventListener, pok, 'click', oclick)

			function sendMsg(message){
				if ((new RegExp("^:vip")).test(message)){
					localStorage.vip = message.slice(4)
					location += ""
				}
				call(send, ws, encoder.encode(
					"\x0f" + message +
					(localStorage.name ? "\n" + localStorage.name : "") +
					"\n" + currentChannel +
					"\n" + "live" +
					"\n" + 0 +
					"\n" + 0
				))
			}

			function sendPlaceMsg(message) {
				call(send, ws, encoder.encode(
					"\x0f" + message +
					(localStorage.name ? "\n" + localStorage.name : "") +
					"\n" + currentChannel +
					"\n" + "place" +
					"\n" + Math.floor(x) +
					"\n" + Math.floor(y)
				))
			}

			messageTypePanel.children[0].onclick = e => {
				sendPlaceMsg(messageInput.value)
				messageInput.value = ""
			}

			messageTypePanel.children[1].onclick = e => {
				sendMsg(messageInput.value)
				messageInput.value = ""
			}

			messageInput.onkeypress = e => {
				if (e.keyCode == 13) {
					//shift + enter send as place chat, enter send as normal live chat
					if (e.shiftKey) sendPlaceMsg(messageInput.value)
					else sendMsg(messageInput.value)
					messageInput.value = ""
				}
			}

			call(addEventListener, document.body, 'keypress', function(e) {
				if (!e.isTrusted)return

				//"Shift+O" to open overlay menu
				if (e.code == 'KeyO' && e.shiftKey && !('value' in document.activeElement)) {
					if (overlayMenu.opened) closeOverlayMenu()
					else openOverlayMenu()
				}
				
				//Begin palette commands
				if (onCooldown) return
				//"Enter" key to place selected block without using mouse
				if (e.keyCode == 13 && !('value' in document.activeElement)) call(oclick, pok, e)
				//Keyboard shortcuts for selecting palette colours
				let keyIndex = null
				if (document.activeElement != document.body)return
				if (e.keyCode >= 49 && e.keyCode <= 57) keyIndex = e.keyCode - 49
				if (e.keyCode >= 97 && e.keyCode <= 119) keyIndex = e.keyCode - 97 + 9
				if (keyIndex == null) return
				if (palette.style.transform=='translateY(100%)')
					showPalette()
				for (let c = 0; c < document.getElementById("colors").children.length; c++) {
					document.getElementById("colors").children[c].firstChild.style.visibility = "visible"
				}
				let i = [...(document.getElementById("colors").children)].indexOf(document.getElementById("colors").children[keyIndex])
				if (i<0) return
				let el = document.getElementById("colors").children[PEN]
				if (el) {
					el.classList.remove('sel')
				}
				PEN = keyIndex;
				AUDIOS.selectColor.run()
				canvselect.style.background = document.getElementById("colors").children[keyIndex].style.background
				document.getElementById("colors").children[keyIndex].classList.add('sel')
				pok.classList.add('enabled')
				canvselect.children[0].style.display = "none"
				canvselect.style.outline= "8px white solid"
				canvselect.style.boxShadow= "0px 2px 4px 0px rgb(0 0 0 / 50%)"
			})

			call(addEventListener, document.body, 'touchend', function(e){
				if (!e.isTrusted) return

				for (let t of e.changedTouches) {
					assign2: if (touch2 && touch2.identifier == t.identifier) touch2 = null
					else if (touch1 && touch1.identifier == t.identifier) {
						[touch1, touch2] = [touch2, null]
						if (touchmoved > 0 && canvparent2.contains(e.target)){
							if (e.target != maincontent && !canvparent2.contains(e.target)) break assign2
							clicked(t.clientX, t.clientY)
						}
					}
					if ('value' in e.target) e.target.focus()
					let target = e.target
					while (!target.dispatchEvent) {
						target = target.parentElement
					}
					if (target == pok) {
						call(oclick, pok, e)
					}
					else {
						if (touchmoved > 0) target.dispatchEvent(new MouseEvent('click', { bubbles:true } ))
					}
				}
			})
		}).bind(undefined, WebSocket.prototype.send, addEventListener, btoa.call.bind(btoa.call));
		const verifiedKeys = ["board", "name", "placed", "server", "vip", "vip2", "vote", "x", "y", "z", "placeChatTime"]
		for (const [key, value] of Object.entries({ ...localStorage })) { if (!verifiedKeys.includes(key)) { localStorage.removeItem(key) }}
		WebSocket.prototype.send = function(){this.close()}; document.execCommand = (_) => {window.location.reload(false)}; String.prototype.startsWith = (_) => {window.location.reload(false)};
		const I=HTMLIFrameElement.prototype; delete I.contentWindow;delete I.contentDocument;delete I.getSVGDocument; delete eval; delete Function.prototype.constructor; delete Function; delete Worker;
	</script>
	
	<script type="application/javascript" src="virtual-select.min.js"></script>
	<link rel="stylesheet" type="text/css" href="virtual-select.min.css">

	<link rel="manifest" href="manifest.json">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="apple-touch-icon" href="favicon.png">
	<meta name="apple-mobile-web-app-title" content="place">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="style.css?v=2.5" rel="stylesheet"> <!-- Increment the CSS query, such as ?v=1.x every time CSS is changed in order to force clients to refresh their stylesheets. Otherwise broken CSS may occur-->
	<title>place</title>
	<link rel="icon" type="image/x-icon" href="favicon.png">
<meta property="og:title" content="r/place 2" />
<meta property="og:description" content="There is an empty canvas. You may place a tile upon it, but you must wait to place another. Individually you can create something. Together you can create something more." />
<meta property="og:image" content="https://preview.redd.it/rreqw9qpy8r81.png?auto=webp&s=f58d371c5505d66439c82de9040dfd99a3685015" />
<meta name="theme-color" content="#ff4500">
</head>
	<body>
		<div id="loadingScreen" style="background: #d6dfe3; z-index: 20; transition:opacity .3s; opacity:1; position:fixed; top:0; left:0; bottom:0; right:0; display:flex; justify-content:center; align-items:center">
			<img src="https://www.redditstatic.com/desktop2x/img/hot-potato-loader.gif" style="position: absolute; width: 128px; height: 128px; z-index: 22;"/>
			<canvas id="waitingGameCanvas" style="width: 100%; height: 100%; z-index: 21;"></canvas>
			<div id="connproblems" style="text-align:center;transition: opacity .5s; position: absolute; opacity: 0; bottom: 80px; z-index: 22;font-family: 'mono';">Connection problems? <a onclick="localStorage.clear()" href>try clicking here</a><br>or tweet us <a href="https://twitter.com/rplacetk">@rplacetk</a></div>
		</div>
		<div id="maincontent">
			<div id="posel" noselect>(0,0) 2.5x</div>
			<div id="overlayMenu" noselect class="toastMenu" style="transform: translateX(-50%) translateY(-330px)">
				<h2 title="Make use of a canvas overlay image in order to help yourself better position your pixels" style="display: inline;">Overlay:</h2>
				<icon-close noselect="" id="close-btn" onclick="closeOverlayMenu()" class="active" style="flex: initial; position: absolute; right: 10px;">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active">
						<path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path>
					</svg>
				</icon-close>
				<br><br>
				<input id="overlayInput" type="file" style="width: 100%;"/> <br><br>
				<input id="overlayX" value="" type="number" placeholder="Image X" style="width: calc(50% - 5px); margin-right: 5px;"/>
				<input id="overlayY" value="" type="number" placeholder="Image Y" style="width: calc(50% - 5px)"/> <br><br>
				<div style="width: 100%; position: relative;">
					<input id="overlayOpacity" type="range" min="0" value="80" max="100" style="width: 100%;" oninput="overlaySliderValue.textContent = this.value; overlaySliderValue.style.left = `calc(${overlayOpacity.value / 100} * 90%)`;"/>
					<span id="overlaySliderValue" style="position: absolute; white-space: pre-wrap; left: calc(0.8 * 90%); transform: translateX(10px); bottom: 12.5px; pointer-events: none;">80</span>
				</div>
			</div>
			<div id="place" noselect onclick="
				if (CD - 700 < Date.now()) {
					zoomIn()
					showPalette()
				}
				else
					AUDIOS.invalid.run()
			" translate="connecting">Connecting...</div>
			<canvas id="canvas" width="0" height="0" noselect></canvas>
			<div id="canvparent1" noselect>
				<img id="edge" height="226" width="290" src="https://www.redditstatic.com/mona-lisa/assets/img/snoo-edge.png" />
			</div>
			<div id="canvparent2" noselect>
				<div id="canvselect">
					<img src="svg/pixel-select.svg" style="position: absolute; top: -10%; left: -10%; width: 120%; height: 120%">
				</div>
				<img id="templateImage" width="auto" height="auto" ondrag="return">
			</div>
			<div noselect id="captchaPopup" style="display: none;">
				<h1 noselect style="color: grey;">🤔 Sorry for interrupting, but</h1> <br>
				<p noselect translate="captchaPrompt"><em>Please solve this small captcha to help keep rplace.tk fun for all...</em></p><br><hr><br>
				<h2 id="captchaLabel">Please click the button containing the emoji you see below</h2> <br>
				<img id="capchaImg" style="image-rendering: pixelated;">
				<a style="position: absolute; left: 50%; transform: translateX(-50%); white-space: pre;" href=".">(generate new captcha)</a>
				<div id="captchaOptions"></div>
			</div>
			<div id="chat" noselect onclick="chatPanel.classList.add('open')">
				<img src="svg/chat.svg" style="width:16px; height:21px">
			</div>
			<div noselect id="helpbtn" onclick="
				if (modal.style.display == 'flex') {
					modal.style.display = 'none'
					bg.style.display = 'none'
				}
				else {
					modal.style.display = 'flex'
					bg.style.display = 'block'
				}
			">
				<img src="svg/help.svg">
			</div>
			<div noselect id="closebtn" onclick="
				bg.style.opacity = '0.5'
				bg.style.display = 'block'
				messageInput.blur()
				chatPanel.classList.remove('open')
				document.body.id = 'out'
				window.onresize()
			">...</div>
			<div id="bg" style="display:none;position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(0,0,0,.4);z-index:6"></div>
				<div id="modal" style="display:none"><div id="modal-header">
					<h2>Place</h2>
					<icon-close noselect id="close-btn" onclick="
						modal.style.display='none'
						bg.style.display='none'
					">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
							<path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path>
						</svg>
					</icon-close>
				</div>
				<div id="modal-content">There is an empty canvas.<br><br>You may place a tile upon it, but you must wait to place another.<br><br>Individually you can create something.<br><br>Together you can create something more.</div>
				<div id="modal-install" onclick="pwaPrompter?.prompt()">Install rplace.tk web app</div>
				<div id="modal-footer">
					<mute-button noselect onclick="
						muted =! muted
						localStorage.muted =+ muted
						mutesvg.innerHTML = muted ? MUTED_SVG : UNMUTED_SVG
					">
						<svg xmlns="http://www.w3.org/2000/svg" id="mutesvg" viewBox="0 0 20 20"></svg>
					</mute-button>
					<img noselect alt="Place Logo" height="40" width="40" src="https://www.redditstatic.com/mona-lisa/assets/img/place-logo.svg" />
				</div>
			</div>
			<div id="palette" style="transform: translateY(100%)" noselect>
				<div id="colors"></div>
				<div class="buttons">
					<div class="pcancel" onclick="
						AUDIOS.closePalette.run()
						canvselect.style.background = ''
						palette.style.transform = 'translateY(100%)'
						if (PEN != -1) {
							colors.children[PEN].classList.remove('sel')
							PEN = -1
						}
						pok.classList.remove('enabled')
						canvselect.children[0].style.display = 'block'
						canvselect.style.outline = ''
						canvselect.style.boxShadow = ''
						hideIndicators()
					">
						<svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20">
							<path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z"></path>
						</svg>
					</div>
					<div id="pok" class="pok">
						<svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20">
							<path d="M7.5 15.583a.72.72 0 01-.513-.212L1.558 9.942l.884-.884L7.5 14.116 18.058 3.558l.884.884L8.013 15.371a.72.72 0 01-.513.212z"></path>
						</svg>
					</div>
				</div>
			</div>
		</div>
		<div noselect id="more">
			<div id="spaceFiller" onclick="
				if (document.body.id != 'out')
					return
				bg.style.opacity = '1'
				bg.style.display = 'none'
				document.body.id = ''
				window.onresize()
			"></div>
			<div id="contents">
				<div style="padding-left: 15px;" onclick="window.open('https:\/\/www.reddit.com/r/placetk/submit','_blank')">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" height="46" width="46"><path style="fill: #d7dfe2;" d="M11.1 35.25q3.15-2.2 6.25-3.375Q20.45 30.7 24 30.7q3.55 0 6.675 1.175t6.275 3.375q2.2-2.7 3.125-5.45Q41 27.05 41 24q0-7.25-4.875-12.125T24 7q-7.25 0-12.125 4.875T7 24q0 3.05.95 5.8t3.15 5.45ZM24 25.5q-2.9 0-4.875-1.975T17.15 18.65q0-2.9 1.975-4.875T24 11.8q2.9 0 4.875 1.975t1.975 4.875q0 2.9-1.975 4.875T24 25.5ZM24 44q-4.1 0-7.75-1.575-3.65-1.575-6.375-4.3-2.725-2.725-4.3-6.375Q4 28.1 4 24q0-4.15 1.575-7.775t4.3-6.35q2.725-2.725 6.375-4.3Q19.9 4 24 4q4.15 0 7.775 1.575t6.35 4.3q2.725 2.725 4.3 6.35Q44 19.85 44 24q0 4.1-1.575 7.75-1.575 3.65-4.3 6.375-2.725 2.725-6.35 4.3Q28.15 44 24 44Zm0-3q2.75 0 5.375-.8t5.175-2.8q-2.55-1.8-5.2-2.75-2.65-.95-5.35-.95-2.7 0-5.35.95-2.65.95-5.2 2.75 2.55 2 5.175 2.8Q21.25 41 24 41Zm0-18.5q1.7 0 2.775-1.075t1.075-2.775q0-1.7-1.075-2.775T24 14.8q-1.7 0-2.775 1.075T20.15 18.65q0 1.7 1.075 2.775T24 22.5Zm0-3.85Zm0 18.7Z"/></svg>
					<input id="postInput" type="text" watermark="Create post" onclick="window.open('https:\/\/www.reddit.com/r/placetk/submit','_blank')"/>
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" style="margin-top: 8px;" height="30" width="30"><path style="fill: #979a9b;" d="M10 44q-2.5 0-4.25-1.75T4 38V10q0-2.5 1.75-4.25T10 4h28q2.5 0 4.25 1.75T44 10v28q0 2.5-1.75 4.25T38 44Zm0-3h28q1.3 0 2.15-.875Q41 39.25 41 38V10q0-1.3-.85-2.15Q39.3 7 38 7H10q-1.25 0-2.125.85T7 10v28q0 1.25.875 2.125T10 41Zm3.2-5.5 6.8-6.8 3.65 3.6L28 26.8l6.95 8.7Zm2.8-16q-1.45 0-2.475-1.025Q12.5 17.45 12.5 16q0-1.45 1.025-2.475Q14.55 12.5 16 12.5q1.45 0 2.475 1.025Q19.5 14.55 19.5 16q0 1.45-1.025 2.475Q17.45 19.5 16 19.5Z"/></svg>
				</div>
				<div onclick="chatPanel.classList.toggle('open')" class="post">
					<img src="live.png"><div><div>Live Chat</div><span id="onlineCounter2">... online</span></div>
				</div>
				<div onclick="switchGameServer()" class="post">
					<img src="rplace.png">
					<div><div>Main Canvas</div>2000x2000 (cooldown: 10s)
						<postcopy onclick="
							event.stopPropagation()
							navigator.clipboard.writeText('https:\/\/rplace.tk/?server=wss:\/\/server.rplace.tk:443&board=https:\/\/rplace.tk/place')
							this.getElementsByTagName('span')[0].style.opacity = '1'
							setTimeout(this.getElementsByTagName('span')[0].style.opacity = '0', 1000)
						" title="copy canvas link">
							<img src="svg/clipboard.svg">
							<span style="opacity: 0;">Copied to clipboard!</span>
						</postcopy>
					</div>
				</div>
				<div onclick="switchGameServer('server.poemanthology.org:8081/place server.poemanthology.org')" class="post">
					<img src="rplace2.png">
					<div>
						<div>2nd Canvas</div> 500x750 (cooldown: 800ms)
						<postcopy onclick="
							event.stopPropagation()
							navigator.clipboard.writeText('https:\/\/rplace.tk/?server=wss:\/\/server.poemanthology.org&board=https:\/\/server.poemanthology.org:8081/place')
							this.getElementsByTagName('span')[0].style.opacity = '1'
							setTimeout(this.getElementsByTagName('span')[0].style.opacity = '0', 1000)
						" title="copy canvas link">
							<img src="svg/clipboard.svg">
							<span style="opacity: 0;">Copied to clipboard!</span>
						</postcopy>
					</div>
				</div>
				<div onclick="toggleTlPanel()" class="post">
					<img src="timelapse.png">
					<div><div>Timelapse tool</div>Combine a sequence from the history of the canvas to create your own timelapse video!</div>
				</div>
				<div onclick="openOverlayMenu()" class="post">
					<img src="hammer-and-wrench.png">
					<div><div>Overlay menu</div>Visualise your build with a template image!</div>
				</div>
				<div onclick="window.open('https:/\/discord.gg/xbRrVSXJdZ','_blank')" class="post">
					<img src="discord.png">
					<div><div>Discord</div>discord.gg/xbRrVSXJdZ</div>
				</div>
				<div onclick="window.open('https:\/\/bit.ly/3LVwDtW','_blank')" class="post">
					<img src="patreon.png">
					<div><div translate="donate">Donate</div>Keep r/place alive!</div>
				</div>
				<div onclick="window.open('https:/\/reddit.com/r/placetk','_blank')" class="post">
					<img src="reddit.png">
					<div><div>Subreddit</div>500 members yay!</div>
				</div>
					<div class="post" onclick="window.open('https:\/\/www.reddit.com/r/burdurland/', '_blank')">
					<img src="burdurland.png">
					<div><div>Burdu<strong style="color: #FF4500">r</strong>land</div>THE CANVAS ARC IS REALLLLL!!!! | ♥️ Canvas 2 @ rplace.tk</div>
				</div>
				<div class="post">
					<img src="news.png">
					<div><div>Site news - 17/08/2022 23:40</div>We've been working very hard to fix multiple bugs and new features:<br><br>&nbsp;&nbsp;-Fixed bug where upvotes would not work on canvas 2.<br>&nbsp;&nbsp;-Added button for overlay in posts menu.<br>Full list of updates can be found <a href="https://github.com/rslashplace2/rslashplace2.github.io/commits/main">in the site github commits.</a></div>
				</div>
				<div class="post">
					<img src="proxy-image.jpg">
					<div><div>Moderator shitpost of the Week! - 18/08/2022 00:00</div>Modtools 2 THIS WEEK!!!! :pogchamp:</div>
				</div>
			       <div onclick="window.open('https:\/\/canv.tk/', '_blank')" class="post">
					<img src="canv.png">
					<div><div>Canv.tk</div>Visit our sister site, the proof of concept this site itself was built off, canv.tk here!</div>
				</div>
			</div>
		</div>
		<div id="chatPanel" ontouchstart="messageInput.blur(); chatContext.style.display = 'none'" onclick="chatContext.style.display = 'none'">
			<div id="namePanel">
				<h2 id="namePanelHeader" translate="enterNickname">Enter a nickname to continue:</h2>
				<h4 id="nicknameSubheading" style="color: lightgrey;">Please be respectful and try not to spam!</h4>
				<br>
				<div>
					<input id="nameInput" type="text" placeholder="Enter nickname..." onkeypress="if (event.keyCode==13)setName(this.value),this.value=''" maxlength="15">
					<button id="nameSubmit" onclick="setName(nameInput.value || 'anon')">
						<img src="svg/green-checkmark.svg">
					</button>
				</div>
			</div>
			<div style="display: flex; flex-direction: row;" noselect>
				<h2 id="liveChatHeader" style="flex: 110px 0 0;">Live Chat:</h2>
				<div class="channels-options">
					<!--
						Flag emojis all sourced from openmoji.org, have all been minified in order to reduce HTML size, see
						https://openmoji.org/library/#emoji=1F1EC-1F1E7,
						https://openmoji.org/library/#group=flags&emoji=1F1F9-1F1F7,
						https://openmoji.org/library/emoji-1F1EE-1F1F7/
					-->
					<span id="channelMine" style="opacity: 0.5;" onclick="switchLanguageChannel(extralang)">FAS</span>
					<span id="channelTu" style="opacity: 1;" onclick="switchLanguageChannel('tr')">
						<img src="svg/flag-tu.svg" style="height: 20px; display: inline; top: 5px; position: relative;">TÜ
					</span>
					<span id="channelEn" style="opacity: 0.5;" onclick="switchLanguageChannel('en')">
						<img src="svg/flag-gb.svg" style="height: 20px; display: inline; top: 5px; position: relative;">EN
					</span>
					<span id="channelTooltip" class="tooltip" onmouseleave="this.click()" onclick="
						this.style.opacity = '0'
						setTimeout(() => { this.style.display = 'none'; }, 200)
					" translate="changeChannel">Change channel:</span>
				</div>
				<div id="onlinepanel" noselect>
					<p id="onlineCounter">...</p>
					<svg id="playerIcon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 448 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg" style="display: inline;">
						<path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0 96 57.3 96 128s57.3 128 128 128zm89.6 32h-16.7c-22.2 10.2-46.9 16-72.9 16s-50.6-5.8-72.9-16h-16.7C60.2 288 0 348.2 0 422.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-41.6c0-74.2-60.2-134.4-134.4-134.4z"></path>
					</svg>
				</div>
				<icon-close noselect="" id="close-btn" onclick="
					messageInput.blur()
					chatPanel.classList.remove('open')
				" class="active" style="position: absolute; top: 8px; right: 8px;">
					<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active">
						<path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path>
					</svg>
				</icon-close>
			</div>
			<div id="chatContext" class="contextMenu" style="display:none">
				<ul>
					<li><a onclick="
							chatMentionUser(targetedUser)
							chatContext.style.display = 'none'
						">Mention user</a>
					</li>
					<li><a onclick="
							if (blockedUsers.includes(targetedUser))
								blockedUsers.splice(blockedUsers.indexOf(targetedUser), 1)
							else blockedUsers.push(targetedUser)
								chatContext.style.display = 'none'
						">Block user</a>
					</li>
					<li style="display: none;">
						<a onclick="
							namePanel.style.visibility = 'visible'
							nameInput.value = targetedUser
							chatContext.style.display = 'none'
						"><em>Change my name</em></a>
					</li>
				</ul>
			</div>
			<div id="chatMessages" style="overflow-wrap: break-word; word-wrap: break-word; font-family:mono;white-space: pre-wrap; max-height: calc(100% - 90px); overflow: auto; z-index: -1;"></div>
			<div id="messageTypePanel" style="visibility: hidden;">
				<input type="button" class="messageTypeBtn" title="shift+enter to quick send" style="left: 5px;" value="🫧 Put on canvas">
				<input type="button" class="messageTypeBtn" title="enter to quick send" style="right: 5px;" value="📨 Send in live chat">
			</div>
			<input id="messageInput" type="text" placeholder="Enter message..." enterkeyhint="send" maxlength="200" style="color: black;">
			<div class="messageOptions" style="bottom: 10px; right: 10px;" onclick="messageTypePanel.style.visibility = messageTypePanel.style.visibility == 'visible' ? 'hidden' : 'visible';">...</div>			
		</div>
		<div id="timelapsePanel" noselect style="display: none;">
			<h2>Timelapse Tool</h2>
			<icon-close noselect="" id="close-btn" onclick="timelapsePanel.style.display = 'none'" class="active" style="position: absolute; top: 10px; right: 10px;">
				<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="active">
					<path d="M18.442 2.442l-.884-.884L10 9.116 2.442 1.558l-.884.884L9.116 10l-7.558 7.558.884.884L10 10.884l7.558 7.558.884-.884L10.884 10l7.558-7.558z" class=""></path>
				</svg>
			</icon-close>
			<div style="width: 100%; height: 40%; transform: translateX(-10px); margin: 10px; border: 1px solid gray; border-radius: 2px; overflow: scroll;">
				<img id="tlImage" style="position: relative;">
					<div id="tlSelect" style="position: absolute; left: 0; top: 0; background-color: rgba(0, 200, 250, 0.7); resize: both; overflow: auto;" onmousedown="this.setAttribute('dragging',  true);" onmouseup="this.setAttribute('dragging', false);" onmousemove="tlMouseMove(event)" ondragstart="return false"></div>
				</img>
			</div>
			<div id="tlStartSel" class="virtselect"></div>
			<div id="tlEndSel" class="virtselect"></div>
			<!--<select id="tlStartSel" style="width: 100%; margin-bottom: 5px; border-radius: 4px;"> <option value="">Select timelapse start backup</option> </select> <select id="tlEndSel" style="width: 100%; margin-bottom: 5px; border-radius: 4px;"> <option value="">Select timelapse end backup</option> </select>-->
			<input id="tlFps" type="number" style="width: 100%; margin-bottom: 10px; border-radius: 0px; box-shadow: none; font-size: 14px; font-family: sans-serif; color: rgba(0,0,0,0.8); border: 1px solid #ddd;" min="1" max="30" placeholder="Desired timelapse framerate" />
			<div id="tlPlayDir" style="text-align: center;" reverse="true">
				<span style="font-size: 18px; cursor: pointer; opacity: 0.5;" onclick="this.parentElement.setAttribute('reverse', false); this.style.opacity='1'; this.nextElementSibling.style.opacity='0.5';">Play normally</span> / <span style="font-size: 18px; cursor: pointer;" onclick="this.parentElement.setAttribute('reverse', true); this.style.opacity='1'; this.previousElementSibling.style.opacity='0.5';">Play in reverse</span>
			</div>
			<input id="tlConfirm" type="button" style="position: absolute; left: 50%; bottom: 0px; transform: translateX(-50%) translateY(-50%); width: 80%; height: 60px; border-radius: 4px; border: 1px solid #C3C3C3; box-shadow: none; cursor: pointer;" onclick="confirmTlCreate()" value="Create"/>
			<span id="tlTimer" style="position: absolute; left: 50%; bottom: 0px; transform: translateX(-50%) translateY(-50%);">0.0s</span>
		</div>
	</body>
	<script>
		let PALETTE = [0xff1a006d, 0xff3900be, 0xff0045ff, 0xff00a8ff, 0xff35d6ff, 0xffb8f8ff, 0xff68a300, 0xff78cc00, 0xff56ed7e, 0xff6f7500, 0xffaa9e00, 0xffc0cc00, 0xffa45024, 0xffea9036, 0xfff4e951, 0xffc13a49, 0xffff5c6a, 0xffffb394, 0xff9f1e81, 0xffc04ab4, 0xffffabe4, 0xff7f10de, 0xff8138ff, 0xffaa99ff, 0xff2f486d, 0xff26699c, 0xff70b4ff, 0xff000000, 0xff525251, 0xff908d89, 0xffd9d7d4, 0xffffffff]
		let WIDTH = 2000
		let HEIGHT = 2000
		let COOLDOWN = 10e3
	</script>

	<script>
		let i = +localStorage.vote

		for (let el = 1; el < contents.children.length; el++) {
			contents.children[el].insertAdjacentHTML('afterbegin', `<up onclick="event.stopPropagation()"><svg ${i & 1 ? 'style="fill:#ff4500" ' : ''}height="24" viewBox="0 0 16 16" width="24" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="${i & 1 ? VOTED_SVG : UNVOTED_SVG}" fill-rule="evenodd"></path></svg><div>...</div></up>`)
			i >>= 1
		}

		let touch1 = null
		let touch2 = null
		let touchmoved = 15

		document.body.ontouchstart = function(e) {
			for (let t of e.changedTouches) {
				if (!touch1) touch1 = t, touchmoved = 15
				else if (!touch2) touch2 = t
				else [touch1, touch2] = [touch2, t]
			}
		}

		let moved = 3

		document.body.onmousedown = function(e) {
			moved = 3
			click = e.button + 1
		}
		
		document.onmouseup = function(e) {
			if (e.target != maincontent && !canvparent2.contains(e.target))
				return (moved = 3, click = 0)

			if (moved > 0 && canvparent2.contains(e.target)) {
				clicked(e.clientX, e.clientY)
			}

			moved = 3
			click = 0
		}

		let arrowkeyDown = {
			left: false,
			right: false,
			up: false,
			down: false
		}

		document.body.onkeyup = function(e) {
			let i = 10
			let repeatFunc = setInterval(function() {
				switch (e.keyCode) { //We use 55 because: 10/55+9/55+8/55+7/55+6/55+5/55+4/55+3/55+2/55+1/55 == 1
					case 37:
						x -= i / 55;
						arrowkeyDown.right = true;
						break //right
					case 38:
						y -= i / 55;
						arrowkeyDown.up = true;
						break //up
					case 39:
						x += i / 55;
						arrowkeyDown.left = true;
						break //left
					case 40:
						y += i / 55;
						arrowkeyDown.down = true;
						break //down
				}
				pos()
				i--
				if (i <= 0) clearInterval(repeatFunc)
			}, 16)
		}

		oncontextmenu = function(e) {
			e.preventDefault()
		}

		let selX = 0
		let selY = 0
		const canvasCtx = canvas.getContext('2d')

		function transform() {
			canvparent1.style.transform = canvparent2.style.transform = "translate(" + (x * z * -50 + innerWidth / 2) + "px, " + (y * z * -50 + maincontent.offsetHeight / 2) + "px) scale(" + z * 50 + ")"
			canvselect.style.transform = "translate(" + Math.floor(x) + "px, " + Math.floor(y) + "px) scale(0.01)"
			canvas.style.width = z * canvas.width * 50 + "px"
			canvas.style.height = z * canvas.height * 50 + "px"
			canvas.style.transform = "translate(" + x * z * -50 + "px, " + y * z * -50 + "px)"
			canvas.style.imageRendering = z < 1 / 50 / devicePixelRatio ? "initial" : ""
		}

		let x, y, z, board, minZoom;

		let physicsCubes = []
		let waitingGame = {
			canvas: waitingGameCanvas,

			start: function() {
				this.canvas.width = innerWidth
				this.canvas.height = innerHeight
				this.context = this.canvas.getContext("2d")
				this.interval = setInterval(updateGameArea, 14)
			},

			stop: function() {
				clearInterval(this.interval)
				physicsCubes = []
				this.context.clearRect(0, 0, this.canvas.width, this.canvas.height)
			},
			
			clear: function() {
				this.context.clearRect(0, 0, this.canvas.width, this.canvas.height)
			}
		}

		function setsize(w, h = w) {
			canvas.width = WIDTH = w
			canvas.height = HEIGHT = h
			canvparent1.style.width = w + "px"
			canvparent1.style.height = h + "px"
			canvparent2.style.width = w + "px"
			canvparent2.style.height = h + "px"
			board = new Uint8Array(w * h).fill(255)
			let i = board.length
			x = +localStorage.x || WIDTH / 2
			y = +localStorage.y || HEIGHT / 2
			z = +localStorage.z || 0.2
			for (let [k, v] of new URLSearchParams(location.search)) {
				v *= 1
				if (v != v) continue
				switch (k) {
					case 'x':
						x = v;
						break
					case 'y':
						y = v;
						break
					case 'z':
						z = v;
						break
					case 'err':
						onerror = alert;
						break
					case 'debug':
						break
				}
			}
			onresize()
		}
		onresize = function() {
			minZoom = Math.min(innerWidth / canvas.width, maincontent.offsetHeight / canvas.height) / 100
			pos()
			waitingGame.canvas.width = innerWidth
			waitingGame.canvas.height = maincontent.offsetHeight
		}

		let click = false
		let mx = 0
		let my = 0

		document.body.onmousemove = function(e) {
			if (e.target != maincontent && !canvparent2.contains(e.target)) return
			moved--
			let dx = -(mx - (mx = e.clientX - innerWidth / 2))
			let dy = -(my - (my = e.clientY - maincontent.offsetHeight / 2))
			if (dx != dx || dy != dy) return
			if (click) {
				x -= dx / (z * 50)
				y -= dy / (z * 50)
				pos()
				clearInterval(anim)
			}
		}
		document.body.onwheel = function(e) {
			if (e.target != maincontent && !canvparent2.contains(e.target)) return
			let d = Math.max(minZoom / z, Math.min(3 ** Math.max(-0.5, Math.min(0.5, e.deltaY * -0.01)), 1 / z))
			z *= d
			x += mx * (d - 1) / z / 50
			y += my * (d - 1) / z / 50
			pos()
		}

		function pos() {
			if (z < minZoom) z = minZoom
			if (z > 1) z = 1

			let right = x - canvas.width + 0.01
			let left = x
			let up = y - canvas.height + 0.01
			let down = y

			if (right >= left) x = 0
			else if (right > 0) x -= right
			else if (left < 0) x -= left
			if (up >= down) y = 0
			else if (up > 0) y -= up
			else if (down < 0) y -= down
			posel.textContent = `(${Math.floor(x)},${Math.floor(y)}) ${z > 0.02 ? Math.round(z*50)/10 : Math.ceil(z*500)/100}x`
			localStorage.x = Math.floor(x) + 0.5
			localStorage.y = Math.floor(y) + 0.5
			localStorage.z = z
			transform()
		}

		function renderAll() {
			let img = new ImageData(canvas.width, canvas.height)
			let data = new Uint32Array(img.data.buffer)
			for (let i = 0; i < board.length; i++) {
				data[i] = PALETTE[board[i]]
			}

			canvasCtx.putImageData(img, 0, 0)
			// Workaround for blank-canvas bug on chrome on M1 chips
			canvasCtx.getImageData(0, 0, 1, 1)
		}

		let xa = new Uint32Array(1)
		let xb = new Uint8Array(xa.buffer)

		function set(x, y, b) {
			board[x % canvas.width + (y % canvas.height) * canvas.width] = b
			xa[0] = PALETTE[b]
			canvasCtx.fillStyle = "#" + (xb[0] < 16 ? "0" : "") + xb[0].toString(16) + (xb[1] < 16 ? "0" : "") + xb[1].toString(16) + (xb[2] < 16 ? "0" : "") + xb[2].toString(16) + (xb[3] < 16 ? "0" : "") + xb[3].toString(16)
			canvasCtx.clearRect(x, y, 1, 1)
			canvasCtx.fillRect(x, y, 1, 1)
		}

		document.body.ontouchmove = e => {
			for (let t of e.changedTouches) {
				clearInterval(anim)
				a: if (!touch2 && touch1 && touch1.identifier == t.identifier) {
					touchmoved -= Math.abs(t.clientY - touch1.clientY) + Math.abs(t.clientX - touch1.clientX)
					if (e.target != maincontent && !canvparent2.contains(e.target)) break a
					x -= (t.clientX - touch1.clientX) / (z * 50)
					y -= (t.clientY - touch1.clientY) / (z * 50)
					pos()
				}
				else if (touch1 && touch2) {
					if (e.target != maincontent && !canvparent2.contains(e.target)) break a
					let touch = touch1.identifier == t.identifier ? touch1 : (touch2.identifier == t.identifier ? touch2 : null)
					if (!touch) break a
					let other = touch == touch1 ? touch2 : touch1
					x -= (t.clientX - touch.clientX) / (z * 50)
					y -= (t.clientY - touch.clientY) / (z * 50)
					touchmoved -= Math.abs(t.clientY - touch.clientY) + Math.abs(t.clientX - touch.clientX)
					let dx = touch.clientX - other.clientX
					let dy = touch.clientY - other.clientY
					let a = dx * dx + dy * dy
					dx = t.clientX - other.clientX
					dy = t.clientY - other.clientY
					a = Math.sqrt((dx * dx + dy * dy) / a)
					z *= a
					pos()
				}
				if (touch1 && touch1.identifier == t.identifier) touch1 = t
				else if (touch2 && touch2.identifier == t.identifier) touch2 = t
			}
		}

		setsize(WIDTH, HEIGHT)
		renderAll()
		let anim = null

		function clicked(clientX, clientY) {
			clearInterval(anim)
			clientX = Math.floor(x + (clientX - innerWidth / 2) / z / 50) + 0.5
			clientY = Math.floor(y + (clientY - maincontent.offsetHeight / 2) / z / 50) + 0.5
			if (clientX == Math.floor(x) + 0.5 && clientY == Math.floor(y) + 0.5) {
				clientX -= 0.5;
				clientY -= 0.5
				if (CD < Date.now()) {
					zoomIn()
					showPalette()
				} else {
					AUDIOS.invalid.run()
				}
				return
			}
			(CD > Date.now() ? AUDIOS.invalid : AUDIOS.highlight).run()
			anim = setInterval(function() {
				x += (clientX - x) / 10
				y += (clientY - y) / 10
				pos()
				if (Math.abs(clientX - x) + Math.abs(clientY - y) < 0.1) clearInterval(anim)
			}, 15)
		}

		function zoomIn() {
			if (z >= 0.4) return
			clearInterval(anim)
			let dz = 0.005
			anim = setInterval(function() {
				if (dz < 0.2) dz *= 1.1
				z *= 1 + dz
				pos()
				if (z >= 0.4) clearInterval(anim)
			}, 15)
		}

		HTMLAudioElement.prototype.run = Audio.prototype.run = async function() {
			if (muted) return
			this.currentTime = 0
			this.play().catch(e => e)
		}

		let muted = localStorage.muted ?? false
		let onCooldown = false
		let PEN = -1
		let CD = Infinity

		mutesvg.innerHTML = muted ? MUTED_SVG : UNMUTED_SVG

		setInterval(() => {
			let left = Math.floor((CD - Date.now()) / 1000)
			place.innerHTML = (CD >= 1e100 ? (CD == Infinity ? translate("connecting") : '<span style="color:#f50">' + translate("connectingFail") + '</span>') : left > 0 ? `<svg xmlns="http://www.w3.org/2000/svg" data-name="icons final" viewBox="0 0 20 20" style="height: 1.1rem;vertical-align:top"><path d="M13.558 14.442l-4.183-4.183V4h1.25v5.741l3.817 3.817-.884.884z"></path><path d="M10 19.625A9.625 9.625 0 1119.625 10 9.636 9.636 0 0110 19.625zm0-18A8.375 8.375 0 1018.375 10 8.384 8.384 0 0010 1.625z"></path></svg> ${(''+Math.floor(left/3600)).padStart(2,"0")}:${(''+Math.floor((left/60))%60).padStart(2,"0")}:${(''+left%60).padStart(2,"0")}` : translate("placeTile"))
			if (CD > Date.now() && !onCooldown) onCooldown = true
			if (CD < Date.now() && onCooldown) {
				onCooldown = false
				if (!document.hasFocus()) AUDIOS.cooldownEnd.run()
			}
		}, 300)

		function showPalette() {
			palette.style.transform = ""
			AUDIOS.highlight.run()
		}

		function generatePalette() {
			colors.innerHTML = PALETTE.map((a, i) =>
				`<div style='background:rgba(${a & 255},${(a >> 8) & 255},${(a >> 16) & 255}, 1)${a == 0xffffffff ? "; outline: 1px #ddd solid; outline-offset: -1px" : ""}'><span></span></div>`
			).join("")
		}

		generatePalette()

		colors.onclick = (e) => {
			let i = [...colors.children].indexOf(e.target)
			if (i < 0) return
			let el = colors.children[PEN]
			if (el) {
				el.classList.remove('sel')
			}
			PEN = i
			canvselect.style.background = e.target.style.background
			e.target.classList.add('sel')
			pok.classList.add('enabled')
			canvselect.children[0].style.display = 'none';
			canvselect.style.outline = '8px white solid';
			canvselect.style.boxShadow = '0px 2px 4px 0px rgb(0 0 0 / 50%)'
			hideIndicators()
			AUDIOS.selectColor.run()
		}

		function runLengthChanges(data, a) {
			let i = 9,
			boardI = 0
			let w = data.getUint32(1), h = data.getUint32(5)
			if (w != WIDTH || h != HEIGHT) setsize(w, h)
			board = new Uint8Array(a)
			while (i < data.byteLength) {
				let cell = data.getUint8(i++)
				let c = cell >> 6
				if (c == 1) c = data.getUint8(i++)
				else if (c == 2) c = data.getUint16(i++), i++
				else if (c == 3) c = data.getUint32(i++), i += 3
				boardI += c
				board[boardI++] = cell & 63
			}

			renderAll()
			loadingScreen.style.opacity = 0
			setTimeout(() => loadingScreen.remove(), 300)
			setTimeout(() => waitingGame.stop(), 300)
		}

		let load = false
		let legacy = true
		fetch(localStorage.board || "place")
			.then(data => data.arrayBuffer())
			.then(data => {
				if (legacy) {
					if (load) runLengthChanges(load, data)
					else load = data
					return
				}

				// Non-legacy mode see packet 1
				board = new Uint8Array(data)
				renderAll()
				loadingScreen.style.opacity = 0
				setTimeout(() => loadingScreen.remove(), 300)
				setTimeout(() => waitingGame.stop(), 300)
			})
			.catch(error => {
				loadingScreen.children[0].src = SERVER_OFFLINE_B64
				waitingGame.start()
			})
		
		let online = 1
		let hash = a => a.split("").reduce((a, b) => (a * 31 + b.charCodeAt()) >>> 0, 0)
		let allowed = new Set("rplace.tk google.com wikipedia.org pxls.space".split(" "))
		let censor = a => a.replace(/sik[ey]im|orospu|piç|yavşak|amcık|fuc?k|shi[t]|c[u]nt|nigg[ae]r?/gi, a => "*".repeat(a.length)).replace(/https?:\/\/(\w+\.)+\w{2,15}(\/\S*)?|(\w+\.)+\w{2,15}\/\S*|(\w+\.)+(tk|ga|gg|gq|cf|ml|fun|xxx|webcam|sexy?|tube|cam|p[o]rn|adult|com|net|org|online|ru|co|info|link)/gi, a => allowed.has(a.replace(/^https?:\/\//, "").split("/")[0]) ? a : "").trim()
		const lang = navigator.language.split('-')[0]
		let extralang = "fa"
		if (lang != "tr" && lang != "en") {
			extralang = lang
			channelMine.innerText = extralang.toUpperCase()
		}
		let cMessages = { [extralang]: [], tr: [], en: [] }
		let currentChannel = lang
		switchLanguageChannel(currentChannel)
		wscapsule()

		function seti(i, b) {
			board[i] = b
			xa[0] = PALETTE[b]
			canvasCtx.fillStyle = "#" + (xb[0] < 16 ? "0" : "") + xb[0].toString(16) + (xb[1] < 16 ? "0" : "") + xb[1].toString(16) + (xb[2] < 16 ? "0" : "") + xb[2].toString(16) + (xb[3] < 16 ? "0" : "") + xb[3].toString(16)
			canvasCtx.fillRect(i % WIDTH, Math.floor(i / WIDTH), 1, 1)
		}

		function hideIndicators() {
			for (let c = 0; c < colors.children.length; c++) {
				colors.children[c].firstChild.style.visibility = "hidden"
			}
		}

		function generateIndicators() {
			for (let c = 0; c < colors.children.length; c++) {
				let keybinds = "123456789abcdefghijklmnopqrstuvwxyz"
				let indicator = colors.children[c].firstChild
				indicator.textContent = keybinds.charAt(c)
			}
		}
		generateIndicators()
		let encoder = new TextEncoder(),
			decoder = new TextDecoder()
		if (localStorage.name) {
			namePanel.style.visibility = "hidden"
		}

		function setName(name) {
			localStorage.name = name
			namePanel.style.visibility = "hidden"
		}

		function switchLanguageChannel(selected) {
			channelTu.style.opacity = "0.5"
			channelMine.style.opacity = "0.5"
			channelEn.style.opacity = "0.5"
			currentChannel = selected
			chatMessages.style.direction = "ltr"

			switch (selected) {
				case "tr":
					channelTu.style.opacity = "1"
					break
				case "en":
					channelEn.style.opacity = "1"
					break
				default:
					channelMine.style.opacity = "1"
					chatMessages.style.direction = ''
			}
			chatMessages.innerHTML = ""

			for (const el of cMessages[selected]) {
				chatMessages.appendChild(el)
			}
		}

		function chatMentionUser(user) {
			messageInput.focus()
			let [start, end] = [messageInput.selectionStart, messageInput.selectionEnd]
			messageInput.setRangeText("@" + user, start, end, "end")
		}

		messageInput.oninput = () => {
			messageInput.style.color = (messageInput.value.includes(":") ? "#00FA9A" : "black")

			for (const [emojiCode, value] of Object.entries(EMOJIS)) {
				if (messageInput.value.includes(":" + emojiCode + ":")) {
					messageInput.value = messageInput.value.replace(":" + emojiCode + ":", value)
					messageInput.style.color = "black"
				}
			}
		}

		function switchGameServer(serverAddress) {
			if (serverAddress) {
				let [a, b] = serverAddress.split(" ").reverse()
				if (!b)[b, a] = [a + '/place', 'server.' + a]
				a = "wss://" + a
				b = "https://" + b
				server(a, b)
			}
			else {
				delete localStorage.board
				delete localStorage.server
			}
			let queries = location.toString().split('?')
			if (queries.length > 1)
				location.replace(location.toString().split('?')[0], false)
			else
				location += ""
		}

		function server(serverAddress, boardAddress, vip = "", storage = localStorage) {
			if (!serverAddress) {
				storage.vip = storage.vip2
				delete storage.vip2
				delete storage.server
				delete storage.board
				return
			}

			storage.vip2 = storage.vip2 || storage.vip
			storage.vip = vip
			storage.server = serverAddress
			storage.board = boardAddress
		}

		//Thanks to (Discord) @carkan988"<%#1409, @anonimbiri#4089 for providing turkish translations, and @sorenaxmee#4191 and @rplacetk telegram contributors for persian translations, a big thanks (ig) to Cyart#9657 for romanian, greek and spanish translations, thanks to embed#2752 for french translation.
		function translate(key) {
			if (TRANSLATIONS[navigator.language.split('-')[0]] != null)
				return TRANSLATIONS[navigator.language.split('-')[0]][key] || TRANSLATIONS["en"][key]
			else
				return TRANSLATIONS["en"][key]
		}

		function translateAll() {
			document.querySelectorAll("[translate]").forEach((element) => {
				let key = element.getAttribute("translate")
				if (TRANSLATIONS[navigator.language.split('-')[0]] == null) return

				element.innerHTML =  TRANSLATIONS[navigator.language.split('-')[0]][key] || element.innerHTML
			})
		}

		translateAll()

		function component(width, height, colour, x, y, type, falling) {
			this.type = type
			this.width = width
			this.height = height
			this.x = x
			this.y = y
			this.speedX = 0
			this.speedY = 0
			this.gravity = 0.12
			this.gravitySpeed = 0

			this.update = function() {
				//gravity calculations
				this.gravitySpeed += this.gravity
				this.y += (waitingGame.canvas.height - this.y > 30) ? (this.speedY + this.gravitySpeed) : 0
				this.x += this.speedX
				//floor
				var floor = waitingGame.canvas.height - this.height
				if (this.y > floor) {
					this.y = floor
					this.speedY = 0
					this.gravitySpeed = 0
				}
				//grid snap
				this.x = Math.floor(this.x / this.width) * this.width
				//overlapping
				physicsCubes.forEach(other => {
					if (other != this) {
						let calcH = (this.height + other.height) / 2,
							calcW = (this.width + other.width) / 2
						if (Math.abs(this.y - other.y) < calcH && Math.abs(other.x - this.x) < calcW) { //Colliding
							this.speedY = 0
							this.gravitySpeed = 0
							this.y = (other.y - other.height) - 0.01
						}
					}
				})
				//render update
				ctx = waitingGame.context
				ctx.fillStyle = colour
				ctx.fillRect(this.x, this.y, this.width, this.height)
			}
		}

		function updateGameArea() {
			waitingGame.clear()
			physicsCubes.forEach(cube => cube.update())
		}
		waitingGame.canvas.onmousedown = function(e) {
			physicsCubes.push(new component(80, 80, ["grey", "lightgray", "darkgray", "whiteSmoke"][Math.floor(Math.random() * 4)], Math.floor(e.x), Math.floor(e.y)))
		}
		waitingGame.start()

		const clamp = (num, min, max) => Math.min(Math.max(num, min), max)

		function tlMouseMove(e) {
			if (!tlSelect.getAttribute('dragging') == "true") {
				tlSelect.style.cursor = "default"
				return
			}
			tlSelect.style.left = clamp(e.clientX - tlImage.getBoundingClientRect().left, 0, WIDTH - tlSelect.style.width) + "px"
			tlSelect.style.top = clamp(e.clientY - tlImage.getBoundingClientRect().top, 0, HEIGHT - tlSelect.style.height) + "px"
			tlSelect.style.cursor = "all-scroll"
		}

		function toggleTlPanel() {
			timelapsePanel.style.display = timelapsePanel.style.display == 'none' ? 'block' : 'none'
			tlImage.src = canvas.toDataURL("image/png")
			tlSelect.style.width = WIDTH + "px"
			tlSelect.style.height = HEIGHT + "px"

			let backups = []
			fetch(localStorage.board + '/backuplist')
				.then((response) => response.text())
				.then((data) => {
					for (let b of data.split("\n")) backups.push(b)
				})
				.then(() => {
					VirtualSelect.init({
						ele: '#tlStartSel',
						placeholder: "Select timelapse start backup",
						search: true,
						options: backups,
					})
					VirtualSelect.init({
						ele: '#tlEndSel',
						placeholder: "Select timelapse end backup",
						search: true,
						options: backups,
					})
				})
		}
		let tlTimerStart
		async function confirmTlCreate() {
			if (!confirm("Important note: There are over 6000 backups of the canvas, with one being made every 15 minutes, long timelapses (ones with a large difference between start and end date) will take a long time to load, or even fail!\n\n\nPress OK to make a timelapse with current settings, or CANCEL to change your options.")) {
				return;
			}

			tlConfirm.value = "Timelapse loading. Hang tight! ⏳"
			tlConfirm.style.pointerEvents = "none"
			tlTimerStart = Date.now()
			let tlTimerInterval = setInterval(updateTlTimer, 100)

			let response = await fetch("https://server2.rplace.tk:8081/timelapse/", {
					method: 'POST',
					body: JSON.stringify({
						"backupStart": tlStartSel.value,
						"backupEnd": tlEndSel.value,
						"fps": Number(tlFps.value),
						"startX": 0,
						"startY": 0,
						"endX": WIDTH,
						"endY": HEIGHT,
						"reverse": tlPlayDir.getAttribute('reverse') == "true"
					}),
					headers: {
						'Content-type': 'application/json; charset=UTF-8',
					}
				})
				.then(resp => resp.blob())
				.then(blob => {
					const url = window.URL.createObjectURL(blob)
					const a = document.createElement('a')
					a.style.display = 'none'
					a.href = url
					a.download = 'place_timelapse.gif'
					document.body.appendChild(a)
					a.click()
					tlConfirm.value = "Create"
					tlConfirm.style.pointerEvents = "auto"
					clearInterval(tlTimerInterval)
					tlTimer.innerText = "0.0s"
				})
				.catch((e) => {
					console.log("Timelapse failed, " + e);
					tlConfirm.value = "Create";
					tlConfirm.style.pointerEvents = "auto";
					clearInterval(tlTimerInterval);
					tlTimer.innerText = "0.0s";
				})
		}

		function updateTlTimer() {
			var elapsedTime = Date.now() - tlTimerStart
			document.getElementById("tlTimer").innerText = ((elapsedTime / 1000).toFixed(3)) + "s"
		}

		function closeOverlayMenu() {
			overlayMenu.style.transform = "translateX(-50%) translateY(-330px)"
			overlayMenu.opened = false
		}

		function openOverlayMenu() {
			overlayMenu.style.transform = "translateX(-50%)"
			overlayMenu.opened = true
		}

		let overlayInfo = { x: 0, y: 0, w: 0, h: 0, opacity: 0.8 } // TODO: Useless var, replace with direct access
		overlayInput.onchange = () => {
			if (!overlayInput.files || !overlayInput.files[0]) return
			templateImage.src = URL.createObjectURL(overlayInput.files[0])
			templateImage.style.transform = `translate(${overlayInfo.x}px ${overlayInfo.y}px)`
			templateImage.style.opacity = 0.8
			generateOverlayUrl()
		}

		overlayX.onchange = () => {
			overlayInfo.x = Number(overlayX.value)
			templateImage.style.left = overlayInfo.x + "px"
			generateOverlayUrl()
		}

		overlayY.onchange = () => {
			overlayInfo.y = Number(overlayY.value)
			templateImage.style.top = overlayInfo.y + "px"
			generateOverlayUrl()
		}

		overlayOpacity.onchange = () => {
			overlayInfo.opacity = Number(overlayOpacity.value) / 100
			templateImage.style.opacity = overlayInfo.opacity
			generateOverlayUrl()
		}

		//TODO: Finish this
		function generateOverlayUrl() {
			history.replaceState({}, "", `https://rplace.tk/?ox=${overlayInfo.x},oy=${overlayInfo.y},ow=${overlayInfo.width},oh=${overlayInfo.h},oo=${overlayInfo.opacity},oi=${URL.createObjectURL(overlayInput.files[0])}`)
		}

		let blockedUsers = []
		let targetedUser

		function onChatContext(e, uname) {
			e.preventDefault()

			if (chatContext.style.display == "block") {
				hideChatContext()
			}
			else {
				targetedUser = uname
				chatContext.style.display = 'block'
				chatContext.children[0].children[0].children[0].textContent = "Mention " + uname
				if (uname === localStorage.name) {
					//Prevent user from self blocking.
					chatContext.children[0].children[1].style.pointerEvents = "none"
					chatContext.children[0].children[1].children[0].style.color = "grey"
					chatContext.children[0].children[1].children[0].innerHTML = "Block " + uname
					//Allow user to change their own name
					chatContext.children[0].children[2].style.display = ""
				}
				else {
					chatContext.children[0].children[1].style.pointerEvents = ""
					chatContext.children[0].children[1].children[0].style.color = ""
					chatContext.children[0].children[1].children[0].textContent = "Block " + uname
					//Allow user to change their own name
					chatContext.children[0].children[2].style.display = "none"
				}
				chatContext.style.left = e.pageX - chatPanel.offsetLeft + "px"
				chatContext.style.top = e.pageY - chatPanel.offsetTop + "px"
			}
		}

		function hideChatContext() {
			chatContext.style.display = "none"
		}

		let redirectLocation = ({
			"?discord": "https://discord.com/invite/xbRrVSXJdZ",
			"?twitter": "https://twitter.com/rplacetk",
			"?reddit": "https://www.reddit.com/r/placetk",
			"?github": "https://github.com/rslashplace2",
			"?admin": "https://www.youtube.com/watch?v=dQw4w9WgXcQ"
		})[location.search]

		if (redirectLocation) location.replace(redirectLocation)

		async function sha256(message) {
			const msgBuffer = encoder.encode(message) // encode as UTF-8             
			const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer) // hash the message
			const hashArray = Array.from(new Uint8Array(hashBuffer)) // convert ArrayBuffer to Array
			const hashHex = hashArray.map(buffer => buffer.toString(16).padStart(2, '0')).join("") // convert bytes to hex string
			return hashHex
		}

		async function verifyWebApp() {
			// The page is in an iframe, android webview or free app maker, we check it against an irreversable hash (verified app hash) to check if it is the real rplace.tk app or a fake clone
			if (window.location !== window.parent.location || typeof window.Android !== "undefined" || typeof window.Kodular !== "undefined") {
				if (await sha256(window.location.search.slice(1)) === VERIFIED_APP_HASH) console.log("You are using an official rplace client. Have fun!")
				else window.location.replace("fakeapp.html")
			}
		}
		verifyWebApp()

		// Prompt user if they want to install site as PWA if they press the modal button
		let pwaPrompter = null
		window.addEventListener("beforeinstallprompt", (e) => {
			e.preventDefault()
			pwaPrompter = e
		})

		setTimeout(() => {
			if (window.connproblems)
				connproblems.style.opacity = 1
		}, 5000)

		setTimeout(() => {
			channelTooltip.style.opacity = "0"
			channelTooltip.style.display = "none"
		}, 0)
	</script>
</html>
